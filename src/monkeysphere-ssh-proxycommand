#!/bin/sh -e

# monkeysphere-ssh-proxycommand: MonkeySphere ssh ProxyCommand hook
#
# The monkeysphere scripts are written by:
# Jameson Rollins <jrollins@fifthhorseman.net>
#
# They are Copyright 2008, and are all released under the GPL, version 3
# or later.

# This is meant to be run as an ssh ProxyCommand to initiate a
# monkeysphere known_hosts update before an ssh connection to host is
# established.  Can be added to ~/.ssh/config as follows:
#  ProxyCommand monkeysphere-ssh-proxycommand %h %p

HOST="$1"
PORT="$2"

usage() {
cat <<EOF >&2
usage: ssh -o ProxyCommand="$(basename $0) %h %p" ...
EOF
}

log() {
    echo "$@" >&2
}

if [ -z "$HOST" ] ; then
    log "host must be specified."
    usage
    exit 1
fi
if [ -z "$PORT" ] ; then
    log "port must be specified."
    usage
    exit 1
fi

# check for the host key in the known_hosts file
hostKey=$(ssh-keygen -F "$HOST")

# if the host key is found in the known_hosts file,
# don't check the keyserver
if [ "$hostKey" ] ; then
    CHECK_KEYSERVER="false"
fi
export CHECK_KEYSERVER

# update the known_hosts file for the host
monkeysphere update-known-hosts "$HOST"

# exec a netcat passthrough to host for the ssh connection
exec nc "$HOST" "$PORT"
